<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Diff Editor with SEARCH/REPLACE Input and Inline Buttons</title>
    <style>
      body {
        margin: 0;
        padding: 20px;
        font-family: sans-serif;
        background-color: #f5f5f5;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      .editor-wrapper {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin-bottom: 20px;
      }

      #main-editor {
        width: 100%;
        height: 400px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }

      .input-area {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin-bottom: 20px;
      }

      .input-header {
        margin-bottom: 15px;
        font-weight: bold;
        color: #333;
      }

      #diff-input {
        width: 100%;
        min-height: 200px;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-family: "Courier New", monospace;
        font-size: 12px;
        line-height: 1.4;
        resize: vertical;
      }

      .input-buttons {
        margin-top: 15px;
        display: flex;
        gap: 10px;
      }

      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }

      .btn-primary {
        background-color: #007bff;
        color: white;
      }

      .btn-secondary {
        background-color: #6c757d;
        color: white;
      }

      .btn:hover {
        opacity: 0.9;
      }

      .status-area {
        margin-top: 20px;
        padding: 15px;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      h1 {
        text-align: center;
        margin-bottom: 20px;
        color: #333;
      }

      .mode-indicator {
        margin-bottom: 10px;
        padding: 10px;
        border-radius: 4px;
        font-size: 14px;
      }

      .mode-normal {
        background-color: #e7f3ff;
        color: #0056b3;
      }

      .mode-diff {
        background-color: #fff3cd;
        color: #856404;
      }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.48.0/min/vs/loader.js"></script>
  </head>

  <body>
    <div class="container">
      <h1>Diff Editor with SEARCH/REPLACE Input and Inline Buttons</h1>

      <div class="mode-indicator" id="mode-indicator">
        <strong>当前模式：</strong> 普通编辑器模式
      </div>

      <div class="input-area">
        <div class="input-header">
          请输入差异内容（格式：-------
          SEARCH\n...之前内容...\n=======\n...修改后内容...\n+++++++ REPLACE）
        </div>
        <textarea id="diff-input" placeholder="示例内容已预填，可修改为其他内容">
------- SEARCH
// 转义HTML，防止XSS攻击
const escapeHTML = (str: string) =>
  str.replace(
    /[&<>"]/g,
    (tag) =>
      ({
        "&": "&",
        "<": "<",
        ">": ">",
        "'": "&#39;",
        '"': "",
      }[tag] || tag)
  );
=======
// 转义HTML，防止XSS攻击
const escapeHTML = (str: string) =>
  str.replace(
    /[&<>"']/g,
    (tag) =>
      ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        "'": "&#39;",
        '"': "&quot;",
      }[tag] || tag)
  );
+++++++ REPLACE</textarea
        >
        <div class="input-buttons">
          <button class="btn btn-primary" onclick="applyDiff()">确认应用修改</button>
          <button class="btn btn-secondary" onclick="resetEditor()">
            重置到初始状态
          </button>
        </div>
      </div>

      <div class="editor-wrapper">
        <div id="main-editor"></div>
      </div>

      <div
        id="diff-navigator"
        style="display: none; margin-top: 15px; text-align: center"
      >
        <div
          style="
            display: inline-block;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 12px 20px;
          "
        >
          <button
            id="prev-change"
            style="
              background: #007bff;
              color: white;
              border: none;
              border-radius: 4px;
              padding: 6px 12px;
              margin-right: 10px;
              cursor: pointer;
            "
          >
            &lt;
          </button>
          <span id="change-counter" style="margin: 0 10px; font-weight: bold; color: #333"
            >&lt; 1 / 0 &gt;</span
          >
          <button
            id="next-change"
            style="
              background: #007bff;
              color: white;
              border: none;
              border-radius: 4px;
              padding: 6px 12px;
              margin-right: 15px;
              cursor: pointer;
            "
          >
            &gt;
          </button>
          <button
            id="accept-all"
            style="
              background: #28a745;
              color: white;
              border: none;
              border-radius: 4px;
              padding: 6px 12px;
              cursor: pointer;
            "
          >
            全部接受
          </button>
        </div>
      </div>
    </div>

    <script>
      // Monaco Editor config
      require.config({
        paths: {
          vs: "https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.48.0/min/vs",
        },
      });

      require(["vs/editor/editor.main"], function () {
        // 初始代码示例
        const initialCode = `// 转义HTML，防止XSS攻击
const escapeHTML = (str: string) =>
  str.replace(
    /[&<>"]/g,
    (tag) =>
      ({
        "&": "&",
        "<": "<",
        ">": ">",
        "'": "&#39;",
        '"': "",
      }[tag] || tag)
  );

// HTML转义函数
const unescapeHTML = (str: string) =>
  str.replace(
    /&([a-zA-Z]+|#[0-9]+|#x[0-9a-fA-F]+);/g,
    (entity) => {
      if (entity.startsWith('&amp;')) return '&';
      if (entity.startsWith('&lt;')) return '<';
      if (entity.startsWith('&gt;')) return '>';
      if (entity.startsWith('&quot;')) return '"';
      if (entity.startsWith('&#39;')) return "'";
      return entity;
    }
  );

// 验证HTML标签
const validateTag = (tag: string) => {
  const regex = /^<\/?[a-zA-Z][a-zA-Z0-9]*[^>]*>$/;
  return regex.test(tag);
};`;

        let editor = null;
        let isDiffMode = false;
        let originalModel = null;
        let modifiedModel = null;
        let activeWidgets = [];
        let modifiedEditor = null;
        let currentChangeIndex = 0;
        let allChanges = [];

        // 创建普通编辑器
        function createNormalEditor() {
          if (editor) {
            editor.dispose();
            clearAllWidgets();
          }

          editor = monaco.editor.create(document.getElementById("main-editor"), {
            value: initialCode,
            language: "typescript",
            theme: "vs",
            automaticLayout: true,
          });

          isDiffMode = false;
          updateModeIndicator();
          hideDiffNavigator();
        }

        // 清除所有小部件
        function clearAllWidgets() {
          if (!modifiedEditor) return;
          activeWidgets.forEach((widget) => {
            modifiedEditor.removeContentWidget(widget);
          });
          activeWidgets = [];
        }

        // 添加行内接受按钮
        function addButtonAtEndOfLine(lineNumber, changeObj) {
          const maxColumn = modifiedEditor.getModel().getLineMaxColumn(lineNumber);

          const buttonNode = document.createElement("div");
          buttonNode.innerHTML = `<button class="accept-modification-btn" style="background: #28a745; color: white; border: none; padding: 2px 8px; font-size: 11px; border-radius: 3px; cursor: pointer; margin-left: 8px; white-space: nowrap;">接受此区域修改</button>`;
          buttonNode.style.pointerEvents = "auto";
          buttonNode.style.cursor = "pointer";
          buttonNode.style.display = "inline-block";
          buttonNode.style.height = "19px";

          buttonNode.onclick = () => {
            acceptSpecificChange(changeObj);
          };

          const contentWidget = {
            getId: () => `my.dynamic.button.widget.${lineNumber}`,
            getDomNode: () => buttonNode,
            getPosition: () => {
              return {
                position: {
                  lineNumber: lineNumber,
                  column: 1000, // 放在行的右侧
                },
                positionAffinity: monaco.editor.PositionAffinity.RightOfInjectedText,
                preference: [monaco.editor.ContentWidgetPositionPreference.EXACT],
              };
            },
          };

          modifiedEditor.addContentWidget(contentWidget);
          activeWidgets.push(contentWidget);
        }

        // 更新差异按钮
        function updateDiffButtons() {
          if (!isDiffMode || !modifiedEditor) return;

          // 清除所有现有的小部件
          clearAllWidgets();

          // 获取差异信息
          const changes = editor.getLineChanges();

          if (changes) {
            changes.forEach((change) => {
              if (change.modifiedEndLineNumber > 0) {
                addButtonAtEndOfLine(change.modifiedEndLineNumber, change);
              }
            });
          }
        }

        // 接受所有更改并应用
        function acceptChanges() {
          if (!isDiffMode || !originalModel || !modifiedModel) return;

          const modifiedContent = modifiedModel.getValue();

          // 创建一个普通编辑器并应用修改
          createNormalEditor();
          editor.setValue(modifiedContent);

          alert("已接受所有更改并应用！");
        }

        // 接受特定区域的更改
        function acceptSpecificChange(change) {
          if (!isDiffMode || !originalModel || !modifiedModel) return;

          const originalContent = originalModel.getValue();
          const modifiedContent = modifiedModel.getValue();

          const originalLines = originalContent.split("\n");
          const modifiedLines = modifiedContent.split("\n");

          // 根据change对象的行号范围来合并更改
          // 注意：Monaco的行号是1-based，数组索引是0-based
          const originalStart = change.originalStartLineNumber - 1;
          const originalEnd = change.originalEndLineNumber;
          const modifiedStart = change.modifiedStartLineNumber - 1;
          const modifiedEnd = change.modifiedEndLineNumber;

          // 创建新的内容：保留未修改区域，只应用当前更改
          let newLines = [];

          // 添加当前更改之前的原始内容
          newLines.push(...originalLines.slice(0, originalStart));

          // 添加当前区域的修改内容
          newLines.push(...modifiedLines.slice(modifiedStart, modifiedEnd));

          // 添加当前更改之后的原始内容（跳过被替换的部分）
          newLines.push(...originalLines.slice(originalEnd));

          const newContent = newLines.join("\n");

          // 更新原始模型为新内容（已应用特定更改）
          originalModel.setValue(newContent);

          alert("已接受当前区域修改！");

          // 更新按钮
          setTimeout(() => {
            updateDiffButtons();
          }, 100);
        }

        // 设置差异导航器
        function setupDiffNavigator() {
          if (!isDiffMode) return;

          // 确保编辑器完全加载
          setTimeout(() => {
            try {
              // 获取所有更改
              allChanges = editor.getLineChanges() || [];
              currentChangeIndex = 0;

              if (allChanges.length > 0) {
                showDiffNavigator();
                updateChangeCounter();
                setupNavigationButtons();

                // 自动跳转到第一个更改
                if (allChanges.length > 0) {
                  jumpToChange(0);
                }
              } else {
                hideDiffNavigator();
              }
            } catch (error) {
              console.error("设置导航器时出错:", error);
              hideDiffNavigator();
            }
          }, 200); // 给编辑器更多时间加载
        }

        // 显示差异导航器
        function showDiffNavigator() {
          const navigator = document.getElementById("diff-navigator");
          if (navigator) {
            navigator.style.display = "block";
          }
        }

        // 隐藏差异导航器
        function hideDiffNavigator() {
          const navigator = document.getElementById("diff-navigator");
          if (navigator) {
            navigator.style.display = "none";
          }
        }

        // 更新更改计数器
        function updateChangeCounter() {
          const counter = document.getElementById("change-counter");
          if (counter && allChanges.length > 0) {
            counter.textContent = `< ${currentChangeIndex + 1} / ${allChanges.length} >`;
          }
        }

        // 设置导航按钮事件
        function setupNavigationButtons() {
          const prevBtn = document.getElementById("prev-change");
          const nextBtn = document.getElementById("next-change");
          const acceptAllBtn = document.getElementById("accept-all");

          if (prevBtn) {
            prevBtn.onclick = navigateToPreviousChange;
          }
          if (nextBtn) {
            nextBtn.onclick = navigateToNextChange;
          }
          if (acceptAllBtn) {
            acceptAllBtn.onclick = acceptAllChanges;
          }
        }

        // 导航到上一个更改
        function navigateToPreviousChange() {
          if (allChanges.length === 0) return;

          currentChangeIndex =
            (currentChangeIndex - 1 + allChanges.length) % allChanges.length;
          jumpToChange(currentChangeIndex);
        }

        // 导航到下一个更改
        function navigateToNextChange() {
          if (allChanges.length === 0) return;

          currentChangeIndex = (currentChangeIndex + 1) % allChanges.length;
          jumpToChange(currentChangeIndex);
        }

        // 跳转到指定更改（仅导航按钮触发）
        function jumpToChange(index, fromNavigation = true) {
          if (index < 0 || index >= allChanges.length || !modifiedEditor) return;

          const change = allChanges[index];
          const lineNumber = Math.max(1, change.modifiedStartLineNumber);

          // 使用延迟确保视图完全渲染
          setTimeout(() => {
            modifiedEditor.revealLineInCenter(lineNumber);

            // 只在导航按钮触发时更新光标位置
            if (fromNavigation) {
              const maxColumn = Math.max(
                1,
                modifiedEditor.getModel().getLineMaxColumn(lineNumber)
              );
              modifiedEditor.setPosition({
                lineNumber: lineNumber,
                column: Math.min(2, maxColumn),
              });
              modifiedEditor.focus();
            }
          }, 50);

          updateChangeCounter();
        }

        // 接受所有更改
        function acceptAllChanges() {
          if (!isDiffMode || !originalModel || !modifiedModel) return;

          const modifiedContent = modifiedModel.getValue();

          // 创建一个普通编辑器并应用所有修改
          createNormalEditor();
          editor.setValue(modifiedContent);

          alert("已全部接受更改并应用！");
        }

        // 刷新差异导航器（当差异内容变化时调用）
        function refreshDiffNavigator() {
          try {
            const newChanges = editor.getLineChanges() || [];

            // 如果变化数量相同，只需要重新计数但保持当前索引
            // 如果变化数量不同，重置索引为0
            const prevCount = allChanges.length;
            allChanges = newChanges;

            if (newChanges.length === 0) {
              hideDiffNavigator();
              return;
            }

            // 如果变化数量减少或者增加，需要重置索引范围
            if (
              prevCount !== newChanges.length ||
              currentChangeIndex >= newChanges.length
            ) {
              currentChangeIndex = Math.min(
                currentChangeIndex,
                Math.max(0, newChanges.length - 1)
              );
            }

            // 强制重新设置导航器（但不触发光标更新）
            if (newChanges.length > 0) {
              showDiffNavigator();
              updateChangeCounter();
              jumpToChange(currentChangeIndex, false); // false表示非导航按钮触发
            } else {
              hideDiffNavigator();
            }
          } catch (error) {
            console.error("刷新导航器时出错:", error);
          }
        }

        // 设置差异导航器
        function setupDiffNavigator() {
          if (!isDiffMode) return;

          // 确保编辑器完全加载
          setTimeout(() => {
            try {
              // 获取所有更改
              allChanges = editor.getLineChanges() || [];
              currentChangeIndex = 0;

              if (allChanges.length > 0) {
                showDiffNavigator();
                updateChangeCounter();
                setupNavigationButtons();

                // 自动跳转到第一个更改（不触发光标更新）
                jumpToChange(0, false);
              } else {
                hideDiffNavigator();
              }
            } catch (error) {
              console.error("设置导航器时出错:", error);
              hideDiffNavigator();
            }
          }, 200); // 给编辑器更多时间加载
        }

        // 创建diff编辑器
        function createDiffEditor(original, modified) {
          if (editor) {
            editor.dispose();
            clearAllWidgets();
          }

          originalModel = monaco.editor.createModel(original, "typescript");
          modifiedModel = monaco.editor.createModel(modified, "typescript");

          editor = monaco.editor.createDiffEditor(
            document.getElementById("main-editor"),
            {
              readOnly: false,
              renderSideBySide: false, // inline diff
              ignoreTrimWhitespace: false,
              automaticLayout: true,
            }
          );

          editor.setModel({
            original: originalModel,
            modified: modifiedModel,
          });

          modifiedEditor = editor.getModifiedEditor();

          isDiffMode = true;
          updateModeIndicator();

          // 延迟确保编辑器完全加载
          setTimeout(() => {
            updateDiffButtons();
            setupDiffNavigator();
          }, 100);

          // 监听差异更新，动态调整导航器
          editor.onDidUpdateDiff(() => {
            refreshDiffNavigator();
          });
        }

        // 更新模式指示器
        function updateModeIndicator() {
          const indicator = document.getElementById("mode-indicator");
          if (isDiffMode) {
            indicator.className = "mode-indicator mode-diff";
            indicator.innerHTML =
              "<strong>当前模式：</strong>差异对比模式（右侧有接受按钮）";
          } else {
            indicator.className = "mode-indicator mode-normal";
            indicator.innerHTML = "<strong>当前模式：</strong>普通编辑器模式";
          }
        }

        // 解析差异内容
        function parseDiffContent(content) {
          const lines = content.split("\n");
          let searchContent = "";
          let replaceContent = "";
          let currentSection = null;

          for (const line of lines) {
            if (line === "------- SEARCH") {
              currentSection = "search";
              continue;
            } else if (line === "=======") {
              currentSection = "replace";
              continue;
            } else if (line === "+++++++ REPLACE") {
              break;
            } else if (currentSection) {
              if (currentSection === "search") {
                searchContent += line + "\n";
              } else if (currentSection === "replace") {
                replaceContent += line + "\n";
              }
            }
          }

          return {
            search: searchContent.trimEnd(),
            replace: replaceContent.trimEnd(),
          };
        }

        // 查找并替换内容
        function findAndReplace(originalContent, searchContent, replaceContent) {
          let modified = originalContent;

          // 如果找到search内容，则替换
          if (originalContent.includes(searchContent)) {
            modified = originalContent.replace(searchContent, replaceContent);
          } else {
            // 如果未找到，尝试按行匹配
            const originalLines = originalContent.split("\n");
            const searchLines = searchContent.split("\n");
            const replaceLines = replaceContent.split("\n");

            if (searchLines.length > 1) {
              for (let i = 0; i < originalLines.length - searchLines.length + 1; i++) {
                const slice = originalLines.slice(i, i + searchLines.length);
                if (slice.join("\n") === searchLines.join("\n")) {
                  originalLines.splice(i, searchLines.length, ...replaceLines);
                  modified = originalLines.join("\n");
                  break;
                }
              }
            }
          }

          return modified;
        }

        // 应用差异
        window.applyDiff = function () {
          const diffInput = document.getElementById("diff-input").value;
          const { search, replace } = parseDiffContent(diffInput);

          if (!search) {
            alert("请输入搜索内容");
            return;
          }

          let originalContent;
          if (isDiffMode) {
            originalContent = originalModel.getValue();
          } else {
            originalContent = editor.getValue();
          }

          const modifiedContent = findAndReplace(originalContent, search, replace);

          // 创建diff编辑器显示修改
          createDiffEditor(originalContent, modifiedContent);

          // 监听差异更新事件
          editor.onDidUpdateDiff(() => {
            updateDiffButtons();
          });

          modifiedEditor.onDidLayoutChange(() => {
            setTimeout(updateDiffButtons, 100);
          });
        };

        // 重置编辑器
        window.resetEditor = function () {
          createNormalEditor();
          document.getElementById("diff-input").value = getDefaultDiffInput();
        };

        // 获取默认差异输入
        function getDefaultDiffInput() {
          return `------- SEARCH
// 转义HTML，防止XSS攻击
const escapeHTML = (str: string) =>
  str.replace(
    /[&<>"]/g,
    (tag) =>
      ({
        "&": "&",
        "<": "<",
        ">": ">",
        "'": "&#39;",
        '"': "",
      }[tag] || tag)
  );
=======
// 转义HTML，防止XSS攻击
const escapeHTML = (str: string) =>
  str.replace(
    /[&<>"']/g,
    (tag) =>
      ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        "'": "&#39;",
        '"': "&quot;",
      }[tag] || tag)
  );
+++++++ REPLACE`;
        }

        // 初始化
        createNormalEditor();
      });
    </script>
  </body>
</html>
