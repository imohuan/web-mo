# 代码差异应用功能说明

## 功能概述

在 ChatInput 组件中实现了对 OpenAI 流式响应的监听，能够自动检测代码块并识别特定格式的代码差异，然后自动应用到编辑器中。

## 核心功能

### 1. 流式代码块监听

- **实时监听**：监听 OpenAI 的流式响应数据
- **增量处理**：只处理新增的内容，提高性能
- **代码块检测**：自动识别 \`\`\`开始和结束的代码块
- **语言识别**：支持识别代码块的语言类型

### 2. 差异格式检测

当检测到完整的代码块时，会自动检查是否包含以下格式的差异代码：

```
------- SEARCH
旧代码内容
=======
新代码内容
+++++++ REPLACE
```

### 3. 自动应用差异

如果检测到差异格式，会：

1. 触发自定义事件 `applyCodeDiff`
2. 通过事件传递差异内容
3. 调用编辑器的 `applyDiff` 方法
4. 在编辑器中以差异对比模式显示更改

## 实现细节

### useCodeEditor.ts 中的关键函数

1. **monitorStreamContent()**: 监听流式内容更新
2. **detectAndApplyDiff()**: 检测差异格式并触发事件
3. **handleCompleteCodeBlock()**: 处理完整的代码块
4. **resetStreamMonitor()**: 重置监听器状态

### App.vue 中的事件处理

- **handleCodeDiffEvent()**: 处理差异应用事件
- **handleSendMessage()**: 在发送新消息时重置监听器状态

### 事件流程

1. 用户发送消息 → 重置监听器状态
2. OpenAI 流式响应 → 实时监听内容更新
3. 检测到代码块开始 → 开始累积代码内容
4. 检测到代码块结束 → 检查是否为差异格式
5. 如果是差异格式 → 触发 `applyCodeDiff` 事件
6. App.vue 监听事件 → 调用编辑器的 `applyDiff` 方法

## 使用示例

### 1. 普通代码块（自动提取HTML）

```html
<!DOCTYPE html>
<html>
  <head>
    <title>示例页面</title>
  </head>
  <body>
    <h1>Hello World</h1>
  </body>
</html>
```

### 2. 差异格式代码（自动应用差异）

```
------- SEARCH
<title>示例页面</title>
=======
<title>更新后的页面</title>
<meta charset="UTF-8">
+++++++ REPLACE

------- SEARCH
<h1>Hello World</h1>
=======
<h1>欢迎来到新页面</h1>
<p>这是更新后的内容</p>
+++++++ REPLACE
```

## 优势

1. **实时性**：流式处理，无需等待完整响应
2. **智能识别**：自动区分普通代码和差异代码
3. **无缝集成**：与现有编辑器功能完美结合
4. **用户友好**：自动化处理，无需手动操作

## 注意事项

1. 差异格式必须严格按照 `------- SEARCH` / `=======` / `+++++++ REPLACE` 的格式
2. 每次新对话开始时会自动重置监听器状态
3. 支持多个差异块的批量处理
4. 如果差异应用失败，会在控制台显示错误信息

## 调试信息

功能运行时会在浏览器控制台输出详细的调试信息：

- 代码块开始/结束检测
- 差异格式识别
- 事件触发状态
- 应用结果反馈

这些信息有助于排查问题和优化性能。
